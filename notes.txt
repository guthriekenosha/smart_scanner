smart_scanner/
├─ config.py
├─ blofin_client.py
├─ indicators.py
├─ regime.py
├─ bandit.py
├─ strategies.py
├─ signal_types.py
├─ signal_engine.py
├─ lifecycle.py
├─ ws_public.py
└─ scanner_runner.py

External Signal Gateway (smart_scanner/signal_gateway.py)
-------------------------------------------------------
Run a small HTTP server to accept external signals and route them to the built‑in AutoTrader.

Usage:
  python -m smart_scanner.signal_gateway --host 0.0.0.0 --port 8080

Env options:
  WEBHOOK_SECRET=your_shared_token
  WEBHOOK_HOST=0.0.0.0
  WEBHOOK_PORT=8080

Endpoint:
  POST /signal (alias: /webhook)
  Headers (optional): X-Webhook-Token: your_shared_token
  Body (JSON):
    {
      "symbol": "BTC-USDT",          // or "ticker": "BINANCE:BTCUSDT"
      "side": "buy",                 // buy/sell or long/short
      "timeframe": "15m",            // optional, defaults "ext"
      "price": 61234.56,              // optional; server fetches last if missing
      "score": 4.2,                   // used by AutoTrader eligibility
      "prob": 0.66,                   // used by AutoTrader eligibility
      "components": ["tv_signal"],   // optional
      "tags": ["external"]           // optional
    }

AutoTrader gates (from .env via CONFIG):
  ENABLE_AUTOTRADE=1        # enable routing to trader
  PAPER_TRADING=1           # use paper fills (keep at 1 until validated)
  TRADE_NOTIONAL_USD=50     # per-trade notional (USD)
  TRADE_MIN_SCORE=3.6       # min score to accept
  TRADE_MIN_PROB=0.62       # min probability to accept

Notes:
  - When PAPER_TRADING=1, fills are simulated and logged to scanner_metrics.jsonl.
  - When PAPER_TRADING=0, valid API keys are required in smart_scanner/.env and orders are sent to BloFin.
  - Symbol normalization handles BINANCE:BTCUSDT, BTCUSDT, BTC/USDT, btc-usdt -> BTC-USDT.


# recommended env (override anything you want)
export BLOFIN_BASE_URL="https://openapi.blofin.com"
export BLOFIN_API_KEY="..."
export BLOFIN_API_SECRET="..."
export BLOFIN_API_PASSPHRASE=""

export SCAN_TIMEFRAMES="1m,3m,5m,15m"
export TOP_SYMBOLS=80
export CANDLES_CONCURRENCY=6
export CANDLES_CHUNK=24
export CANDLES_INTER_CHUNK_SLEEP=0.6
export SCORE_MIN=3.0

export PRINT_LIQUIDITY_DEBUG=1

export MIN_QUOTE_VOL_USDT=200000
export MIN_LAST_PRICE=0.01
export MAX_CANDIDATES_PER_TF=8
export MAX_CANDIDATES_PER_LOOP=24
export REQUIRE_MULTI_COMPONENTS=1

python -m smart_scanner.scanner_runner --loop


Event-driven mode (WS candle closes)
- Ensure in smart_scanner/.env:
  - USE_WS_CANDLES=1
  - UNIVERSE_FROM_WS=1
  - (optional) SWAP_ONLY=1
- Run: python -m smart_scanner.scanner_runner --event

New toggles in smart_scanner/.env
- REQUIRE_MULTI_COMPONENTS=1           # require >= MIN_COMPONENTS strategies to pass
- MIN_COMPONENTS=2
- SWAP_ONLY=1                          # only include SWAP in WS universe
- EXCLUDE_PATTERNS=BTCDOM-*,XAUT-*     # pattern-based excludes for universe
- BLUECHIP_ONLY=1                      # keep only configured blue-chip bases
- BLUECHIP_BASES=BTC,ETH,SOL,BNB,XRP,DOGE,ADA,LINK,DOT,LTC,TRX,AVAX,BCH,XMR,ATOM,FIL,AAVE,UNI,ETC,NEAR
- METRICS_ENABLED=1
- METRICS_PATH=scanner_metrics.jsonl
- BANDIT_STATE_PATH=bandit_state.json

Metrics
- Signals are appended as JSONL to METRICS_PATH when METRICS_ENABLED=1

Bandit persistence
- Weights load from BANDIT_STATE_PATH on start; saved every 5 minutes.

Orderflow WS (books + trades)
- Enable with USE_WS_ORDERFLOW=1
- Gating options:
  - MAX_SPREAD_BPS=8.0     # skip symbols with wider spreads
  - MIN_TRADES_PER_MIN=2.0 # require minimum trade activity
  - ORDERFLOW_WINDOW_SEC=60

Calibrated probability
- Provide a JSON file at CALIBRATION_PATH with fields:
  {"bias": 0.0, "coef": {"score": 0.8, "ret_5": 0.2, "atr14_pct": -0.5, ...}}
- If present, it overrides the heuristic probability.

Backtest
- Run: python -m smart_scanner.backtest --metrics scanner_metrics.jsonl --tp 0.01 --sl 0.005 --horizon 10


#Prefer WS-driven universe and candles
UNIVERSE_FROM_WS=1
USE_WS_CANDLES=1

#Universe hygiene
SWAP_ONLY=1
BLUECHIP_ONLY=0
BLUECHIP_BASES=0
EXCLUDE_PATTERNS=0

#Liquidity/quality gates
MIN_QUOTE_VOL_USDT=400000
MIN_LAST_PRICE=0.02
TOP_SYMBOLS=450
SIGNAL_MIN_QVOL_USDT=400000

#Strategy gating
REQUIRE_MULTI_COMPONENTS=1
MIN_COMPONENTS=1
SCORE_MIN=6

#Risk/margin safety
MIN_INITIAL_MARGIN_USD=10
CHECK_BALANCE_BEFORE_ORDER=1
UPSIZE_TO_MIN_MARGIN=1
ENFORCE_MIN_MARGIN=1
ENFORCE_MIN_MARGIN_ACTION=close
SINGLE_POSITION_PER_SYMBOL=1

#Orderflow (leave off for now)
USE_WS_ORDERFLOW=0
ORDERFLOW_STRICT=1
OF_READY_MIN_TRADES=1
OF_READY_MAX_AGE_SEC=180
WS_BOOK_DEPTH=10
MAX_SPREAD_BPS=12.0
MIN_TRADES_PER_MIN=0.3
MIN_NOTIONAL_PER_MIN_USD=5000
MIN_DEPTH_NOTIONAL_USD=10000
ORDERFLOW_WINDOW_SEC=120

#Metrics + persistence (use the container volume)
METRICS_ENABLED=1
METRICS_PATH=/data/scanner_metrics.jsonl
BANDIT_STATE_PATH=/data/bandit_state.json
UNIVERSE_CACHE_PATH=/data/.universe_cache.json
CALIBRATION_PATH=/data/calibration.json
PRINT_DIAGNOSTICS=1

#Trading (live)
ENABLE_AUTOTRADE=1
PAPER_TRADING=0
TRADING_MARGIN_MODE=cross
TRADING_POSITION_MODE=net
TRADING_LEVERAGE=3
ENABLE_PRIVATE_WS=1

#TP/SL
ENABLE_TPSL=1
ENABLE_SMART_TPSL=1
TPSL_MODE=atr
TP_BPS=80
SL_BPS=50
TRIGGER_EPS_BPS=8
TPSL_RETRY_ON_FAIL=1
TPSL_RETRY_MULT=3.0
TPSL_RETRY_TRIGGER_TYPE=mark

#Trailing / Break-even
ENABLE_TRAILING=1
BREAK_EVEN_AFTER_R=1.0
BREAK_EVEN_BUFFER_BPS=6
TRAIL_MODE=atr
TRAIL_ATR_MULT=1.0

#Sizing / limits
TRADE_NOTIONAL_USD=50
TRADE_MAX_POSITIONS=6
TRADE_MAX_EXPOSURE_USD=500
TRADE_COOLDOWN_SEC=120

TRADE_MIN_SCORE=5
TRADE_MIN_PROB=0.62
ORDER_SLIPPAGE_BPS=8.0

#Regime awareness
REGIME_AWARE=1
REGIME_TPSL_SHRINK_IN_PANIC=0.6
REGIME_SCORE_BOOST_TREND=0.35
REGIME_SCORE_PENALTY_CHOP=0.25

#EMA slope
EMA_SLOPE_LEN=21
EMA_SLOPE_LOOKBACK=8

#Regime knobs
REGIME_ADX_LEN=14
REGIME_ATR_LEN=14
REGIME_PANIC_ATR_MULT=3.5
REGIME_CHOP_ADX_MAX=18
REGIME_TREND_ADX_MIN=20

