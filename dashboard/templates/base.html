<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Smart Scanner Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/sse.js"></script>
    <!-- Tailwind v3 CDN (enables arbitrary values like max-w-[18rem] and color opacity e.g. bg-blue-50/20) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Dark theme overrides */
      .dark body { background-color: #0f172a; color: #e5e7eb; }
      .dark .bg-white { background-color: #111827 !important; }
      .dark .bg-gray-50 { background-color: #0f172a !important; }
      .dark .bg-gray-100 { background-color: #1f2937 !important; }
      .dark .text-gray-900 { color: #e5e7eb !important; }
      .dark .text-gray-500 { color: #9ca3af !important; }
      .dark table thead { color: #e5e7eb; }
      .dark .shadow { box-shadow: 0 1px 2px rgba(0,0,0,.6); }
      .cursor-pointer { cursor: pointer; }
      .live-dot { display:inline-block; width:6px; height:6px; border-radius:9999px; background:#9ca3af; margin-left:4px; vertical-align:middle; }
      .live { background:#10b981 !important; animation:pulse 0.9s ease-in-out 3; }
      @keyframes pulse { 0%{ box-shadow:0 0 0 0 rgba(16,185,129,.7);} 70%{ box-shadow:0 0 0 6px rgba(16,185,129,0);} 100%{ box-shadow:0 0 0 0 rgba(16,185,129,0);} }
      .sticky-top { position: sticky; top: 0; z-index: 30; background: inherit; }
      /* Drawer overlay */
      #drawer .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); }
      #drawer .panel { position: fixed; right: 0; top: 0; bottom: 0; width: min(720px, 100%); background: #fff; overflow: auto; padding: 1rem; }
      .dark #drawer .panel { background: #111827; }
      pre.json { white-space: pre-wrap; word-break: break-word; }
    </style>
    <script>
      (function() {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') document.documentElement.classList.add('dark');
      })();
      function toggleTheme(){
        const el = document.documentElement;
        const dark = el.classList.toggle('dark');
        localStorage.setItem('theme', dark ? 'dark' : 'light');
      }
      function closeDrawer(){ const d = document.getElementById('drawer'); if (d) d.innerHTML=''; }
      document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ closeDrawer(); }});
      function copyDrawerJSON(){
        const pre = document.querySelector('#drawer pre.json');
        if(pre && navigator.clipboard){ navigator.clipboard.writeText(pre.innerText); }
      }
      function setSigFilter(side, tf){ if(side!==null) localStorage.setItem('sig_side', side); if(tf!==null) localStorage.setItem('sig_tf', tf); }
      function setOrderFilter(kind){ localStorage.setItem('ord_kind', kind); }
      function nextDir(prefix, col){
        const sKey = prefix + '_sort';
        const dKey = prefix + '_dir';
        const prevS = localStorage.getItem(sKey);
        const prevD = localStorage.getItem(dKey) || 'desc';
        const dir = (prevS === col && prevD === 'desc') ? 'asc' : 'desc';
        localStorage.setItem(sKey, col);
        localStorage.setItem(dKey, dir);
        return dir;
      }
      function applySignalsSort(col){
        const side = localStorage.getItem('sig_side') || 'all';
        const tf = localStorage.getItem('sig_tf') || 'all';
        const dir = nextDir('sig', col);
        window.htmx.ajax('GET', `/partials/signals?side=${side}&tf=${tf}&sort=${col}&dir=${dir}`, {target:'#signals', swap:'outerHTML'});
      }
      function applyOrdersSort(col){
        const kind = localStorage.getItem('ord_kind') || 'all';
        const dir = nextDir('ord', col);
        window.htmx.ajax('GET', `/partials/orders?kind=${kind}&sort=${col}&dir=${dir}`, {target:'#orders', swap:'outerHTML'});
      }
      function applyErrorsSort(col){
        const eSort = nextDir('err', col);
        window.htmx.ajax('GET', `/partials/errors?sort=${col}&dir=${eSort}`, {target:'#errors', swap:'outerHTML'});
      }
      function applyPosSort(col){
        const dir = nextDir('pos', col);
        window.htmx.ajax('GET', `/partials/positions?sort=${col}&dir=${dir}`, {target:'#positions', swap:'outerHTML'});
      }
      function applySavedFilters(){
        if (window.htmx){
          const side = localStorage.getItem('sig_side') || 'all';
          const tf = localStorage.getItem('sig_tf') || 'all';
          const sSort = localStorage.getItem('sig_sort') || 'ts';
          const sDir = localStorage.getItem('sig_dir') || 'desc';
          window.htmx.ajax('GET', `/partials/signals?side=${side}&tf=${tf}&sort=${sSort}&dir=${sDir}`, {target:'#signals', swap:'outerHTML'});
          const kind = localStorage.getItem('ord_kind') || 'all';
          const oSort = localStorage.getItem('ord_sort') || 'ts';
          const oDir = localStorage.getItem('ord_dir') || 'desc';
          window.htmx.ajax('GET', `/partials/orders?kind=${kind}&sort=${oSort}&dir=${oDir}`, {target:'#orders', swap:'outerHTML'});
          const pSort = localStorage.getItem('pos_sort') || 'symbol';
          const pDir = localStorage.getItem('pos_dir') || 'asc';
          window.htmx.ajax('GET', `/partials/positions?sort=${pSort}&dir=${pDir}`, {target:'#positions', swap:'outerHTML'});
        }
      }
      function resetFilters(){
        try{ localStorage.clear(); }catch(_){}
        applySavedFilters();
        try{ refreshCounts(); }catch(_){}
      }
      function autoResort(){
        const ss = localStorage.getItem('sig_sort') || 'ts';
        if (ss !== 'ts') applySignalsSort(ss);
        const os = localStorage.getItem('ord_sort') || 'ts';
        if (os !== 'ts') applyOrdersSort(os);
        const es = localStorage.getItem('err_sort') || 'ts';
        if (es !== 'ts') applyErrorsSort(es);
      }
      function fmtAgo(s){ s=Math.max(0,Math.floor(s)); if(s<60) return s+"s ago"; const m=Math.floor(s/60); if(m<60) return m+"m ago"; const h=Math.floor(m/60); return h+"h ago"; }
      function refreshCounts(){
        fetch('/api/summary').then(r=>r.json()).then(j=>{
          const sc = document.getElementById('sig_count'); if (sc) sc.innerText = `(${j.signals})`;
          const oc = document.getElementById('ord_count'); if (oc) oc.innerText = `(${j.orders})`;
          const ec = document.getElementById('err_count'); if (ec) ec.innerText = `(${j.errors})`;
          const dot = document.getElementById('sig_dot');
          if (dot){
            const now = Date.now()/1000;
            const age = (j.last_signal_ts ? (now - j.last_signal_ts) : 1e9);
            const fresh = age < 10; // green if last signal within 10s
            dot.className = `inline-block align-middle w-2 h-2 rounded-full ${fresh ? 'bg-green-500' : 'bg-gray-400'} ml-1`;
            dot.title = j.last_signal_ts ? `${Math.max(0, Math.floor(age))}s ago` : 'no recent signal';
          }
          const sigLast = document.getElementById('sig_last_t'); if(sigLast){ const now=Date.now()/1000; sigLast.innerText = j.last_signal_ts ? fmtAgo(now - j.last_signal_ts) : '—'; }
          const ordLast = document.getElementById('ord_last_t'); if(ordLast){ const now=Date.now()/1000; ordLast.innerText = j.last_order_ts ? fmtAgo(now - j.last_order_ts) : '—'; }
          const errLast = document.getElementById('err_last_t'); if(errLast){ const now=Date.now()/1000; errLast.innerText = j.last_error_ts ? fmtAgo(now - j.last_error_ts) : '—'; }
          const posLast = document.getElementById('pos_last_t'); if(posLast){ const now=Date.now()/1000; posLast.innerText = j.last_position_ts ? fmtAgo(now - j.last_position_ts) : '—'; }
          const sumLast = document.getElementById('sum_last'); const hb = document.getElementById('hb_dot'); if(sumLast && hb){ const now = new Date(); sumLast.innerText = now.toLocaleTimeString(); hb.className = `inline-block w-2 h-2 rounded-full ${hb.className.includes('bg-green-500')? 'bg-gray-400':'bg-green-500'}`; }
          const pnlLast = document.getElementById('pnl_last_t'); if(pnlLast){ const now=Date.now()/1000; pnlLast.innerText = j.last_order_ts ? fmtAgo(now - j.last_order_ts) : '—'; }
        }).catch(()=>{});
      }
      document.addEventListener('DOMContentLoaded', function(){ setTimeout(applySavedFilters, 60); setInterval(autoResort, 5000); setInterval(refreshCounts, 5000); });
      function markLive(id){ const el=document.getElementById(id); if(!el) return; el.classList.add('live'); setTimeout(()=>el.classList.remove('live'), 2000); }
      // Attach to document to avoid null body before it exists
      document.addEventListener('htmx:afterSwap', function(e){ try{ const t=e.target; if(!t || !t.id) return; if(t.id==='signals') markLive('sig_live'); else if(t.id==='orders') markLive('ord_live'); else if(t.id==='errors') markLive('err_live'); }catch(_){} });
    </script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div class="max-w-7xl mx-auto p-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-semibold">Smart Scanner Dashboard</h1>
        <div class="space-x-2">
          <button onclick="resetFilters()" class="px-2 py-1 text-sm rounded bg-gray-100">Reset Filters</button>
          <button onclick="toggleTheme()" class="px-2 py-1 text-sm rounded bg-gray-100">Toggle Theme</button>
        </div>
      </div>
      {% block content %}{% endblock %}
      <footer class="mt-8 text-sm text-gray-500">Live updates via SSE • FastAPI + HTMX</footer>
    </div>
    <div id="drawer"></div>
  </body>
  </html>
