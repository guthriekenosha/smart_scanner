{% extends "base.html" %}
{% block content %}

<div id="summary" hx-get="/partials/summary" hx-trigger="load, every 5s" hx-swap="outerHTML" hx-include="#summary_mins">
  {% include "_summary.html" %}
  </div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
  <div class="bg-white rounded shadow p-4 lg:col-span-2">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-medium">Positions</h2>
      <div class="space-x-2 text-xs">
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="applyPosSort('symbol')">Symbol</button>
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="applyPosSort('size')">Size</button>
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="applyPosSort('pnl')">PnL</button>
      </div>
    </div>
    <div id="positions" hx-get="/partials/positions" hx-trigger="load, every 5s" hx-swap="outerHTML"></div>
  </div>

  <div class="bg-white rounded shadow p-4 lg:col-span-1">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-medium">PnL (last <span id="pnl_window_label">240</span>m)</h2>
      <select class="border rounded px-1 py-0.5 text-xs" hx-get="/partials/pnl" hx-target="#pnl" hx-swap="outerHTML" onchange="document.getElementById('pnl_window_label').innerText=this.value">
        <option value="60">60</option>
        <option value="120">120</option>
        <option value="240" selected>240</option>
        <option value="480">480</option>
      </select>
    </div>
    <div id="pnl" hx-get="/partials/pnl?mins=240" hx-trigger="load, every 10s" hx-swap="outerHTML"></div>
  </div>

  <div class="bg-white rounded shadow p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-medium">Recent Signals</h2>
      <div class="space-x-2 text-sm">
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="setSigFilter('all','all')" hx-get="/partials/signals?side=all&tf=all" hx-target="#signals" hx-swap="outerHTML">All</button>
        <button class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded" onclick="setSigFilter('buy',null)" hx-get="/partials/signals?side=buy&tf=all" hx-target="#signals" hx-swap="outerHTML">Buys</button>
        <button class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded" onclick="setSigFilter('sell',null)" hx-get="/partials/signals?side=sell&tf=all" hx-target="#signals" hx-swap="outerHTML">Sells</button>
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="setSigFilter(null,'1m')" hx-get="/partials/signals?side=all&tf=1m" hx-target="#signals" hx-swap="outerHTML">1m</button>
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="setSigFilter(null,'5m')" hx-get="/partials/signals?side=all&tf=5m" hx-target="#signals" hx-swap="outerHTML">5m</button>
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="setSigFilter(null,'15m')" hx-get="/partials/signals?side=all&tf=15m" hx-target="#signals" hx-swap="outerHTML">15m</button>
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="setSigFilter(null,'1h')" hx-get="/partials/signals?side=all&tf=1h" hx-target="#signals" hx-swap="outerHTML">1H</button>
      </div>
    </div>
    <div class="overflow-auto max-h-96">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="p-2 cursor-pointer" onclick="applySignalsSort('ts')">Time</th>
            <th class="p-2 text-left cursor-pointer" onclick="applySignalsSort('symbol')">Symbol</th>
            <th class="p-2 cursor-pointer" onclick="applySignalsSort('tf')">TF</th>
            <th class="p-2 cursor-pointer" onclick="applySignalsSort('side')">Side</th>
            <th class="p-2 cursor-pointer" onclick="applySignalsSort('score')">Score</th>
            <th class="p-2 cursor-pointer" onclick="applySignalsSort('prob')">Prob%</th>
            <th class="p-2 cursor-pointer" onclick="applySignalsSort('price')">Price</th>
          </tr>
        </thead>
        <tbody id="signals"
               hx-ext="sse" sse-connect="/stream" sse-swap="signal" hx-swap="beforeend">
          {% for ev in signals %}
            {% include "_row_signal.html" %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="bg-white rounded shadow p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-medium">Orders & TP/SL</h2>
      <div class="space-x-2 text-sm">
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="setOrderFilter('all')" hx-get="/partials/orders?kind=all" hx-target="#orders" hx-swap="outerHTML">All</button>
        <button class="px-2 py-0.5 bg-gray-100 rounded" onclick="setOrderFilter('order')" hx-get="/partials/orders?kind=order" hx-target="#orders" hx-swap="outerHTML">Orders</button>
        <button class="px-2 py-0.5 bg-green-100 text-green-800 rounded" onclick="setOrderFilter('tp')" hx-get="/partials/orders?kind=tp" hx-target="#orders" hx-swap="outerHTML">TP</button>
        <button class="px-2 py-0.5 bg-red-100 text-red-800 rounded" onclick="setOrderFilter('sl')" hx-get="/partials/orders?kind=sl" hx-target="#orders" hx-swap="outerHTML">SL</button>
        <button class="px-2 py-0.5 bg-purple-100 text-purple-800 rounded" onclick="setOrderFilter('trail')" hx-get="/partials/orders?kind=trail" hx-target="#orders" hx-swap="outerHTML">Trail</button>
        <button class="px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded" onclick="setOrderFilter('error')" hx-get="/partials/orders?kind=error" hx-target="#orders" hx-swap="outerHTML">Errors</button>
      </div>
    </div>
    <div class="overflow-auto max-h-96">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="p-2 cursor-pointer" onclick="applyOrdersSort('ts')">Time</th>
            <th class="p-2 text-left cursor-pointer" onclick="applyOrdersSort('kind')">Kind</th>
            <th class="p-2 cursor-pointer" onclick="applyOrdersSort('symbol')">Symbol</th>
            <th class="p-2 cursor-pointer" onclick="applyOrdersSort('side')">Side</th>
            <th class="p-2">Info</th>
          </tr>
        </thead>
        <tbody id="orders" hx-ext="sse" sse-connect="/stream" sse-swap="orders" hx-swap="beforeend">
          {% for ev in orders %}
            {% include "_row_order.html" %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="bg-white rounded shadow p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-medium">Errors</h2>
    </div>
    <div class="overflow-auto max-h-96">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="p-2 text-left">Stage</th>
            <th class="p-2">Symbol</th>
            <th class="p-2">Message</th>
          </tr>
        </thead>
        <tbody id="errors" hx-ext="sse" sse-connect="/stream" sse-swap="errors" hx-swap="beforeend">
          {% for ev in errors %}
            {% include "_row_error.html" %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
